# åŠŸèƒ½å®ç°ç¤ºä¾‹ï¼šç”¨æˆ·æ³¨å†Œ

> ä»¥ç”¨æˆ·æ³¨å†ŒåŠŸèƒ½ä¸ºä¾‹ï¼Œå±•ç¤ºå®Œæ•´çš„å®ç°æ­¥éª¤å’ŒæŠ€æœ¯æ ˆä½¿ç”¨

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

**åŠŸèƒ½åç§°**ï¼šç”¨æˆ·æ³¨å†Œ  
**æ¥å£è·¯å¾„**ï¼š`POST /api/v1/user/register`  
**ä¼˜å…ˆçº§**ï¼šP0ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰  
**é¢„è®¡æ—¶é—´**ï¼š2å°æ—¶

### ä¸šåŠ¡æµç¨‹
```
ç”¨æˆ·æäº¤æ³¨å†Œä¿¡æ¯
    â†“
API Gateway æ¥æ”¶è¯·æ±‚
    â†“
å‚æ•°æ ¡éªŒï¼ˆé‚®ç®±æ ¼å¼ã€å¯†ç å¼ºåº¦ï¼‰
    â†“
è°ƒç”¨ User RPC æœåŠ¡
    â†“
æ£€æŸ¥é‚®ç®±æ˜¯å¦å·²å­˜åœ¨
    â†“
å¯†ç  MD5 åŠ å¯†
    â†“
å†™å…¥æ•°æ®åº“
    â†“
è¿”å›ç”¨æˆ·ID
```

---

## ğŸ› ï¸ æŠ€æœ¯æ ˆ

| å±‚çº§ | æŠ€æœ¯ | ç”¨é€” |
|------|------|------|
| **HTTP æ¡†æ¶** | Hertz | API Gateway æ¥æ”¶ HTTP è¯·æ±‚ |
| **RPC æ¡†æ¶** | Kitex | æœåŠ¡é—´é€šä¿¡ |
| **IDL** | Thrift | æ¥å£å®šä¹‰ |
| **ORM** | GORM + Gen | æ•°æ®åº“æ“ä½œ |
| **åŠ å¯†** | MD5 + Salt | å¯†ç åŠ å¯† |
| **æœåŠ¡å‘ç°** | Consul | RPC æœåŠ¡æ³¨å†Œä¸å‘ç° |
| **é“¾è·¯è¿½è¸ª** | OpenTelemetry | åˆ†å¸ƒå¼è¿½è¸ª |
| **æ—¥å¿—** | Kitex Klog | ç»“æ„åŒ–æ—¥å¿— |

---

## ğŸ“ å®ç°æ­¥éª¤

### Step 1: IDL å®šä¹‰ï¼ˆå·²å®Œæˆï¼‰

**æ–‡ä»¶**ï¼š`server/idl/rpc/user.thrift`

```thrift
// ç”¨æˆ·æ³¨å†Œè¯·æ±‚
struct RegisterRequest {
    1: string email       // é‚®ç®±
    2: string password    // å¯†ç 
    3: string nickname    // æ˜µç§°ï¼ˆå¯é€‰ï¼‰
}

// ç”¨æˆ·æ³¨å†Œå“åº”
struct RegisterResponse {
    1: common.BaseResponse base_resp  // åŸºç¡€å“åº”
    2: i64 user_id                    // ç”¨æˆ·ID
}

service UserService {
    RegisterResponse Register(1: RegisterRequest req)
}
```

**æŠ€æœ¯ç‚¹**ï¼š
- Thrift IDL å®šä¹‰æ¥å£å¥‘çº¦
- ä½¿ç”¨ `common.BaseResponse` ç»Ÿä¸€å“åº”æ ¼å¼

---

### Step 2: æ•°æ®åº“å®ä½“ï¼ˆå·²å®Œæˆï¼‰

**æ–‡ä»¶**ï¼š`server/shared/dal/sqlentity/users.gen.go`

```go
type User struct {
    IDuint64         `gorm:"column:id;primaryKey;autoIncrement"`
    Username    string         `gorm:"column:username;uniqueIndex"`
    Email       string         `gorm:"column:email;uniqueIndex"`
    Password    string         `gorm:"column:password"`
    Nickname    *string        `gorm:"column:nickname"`
    Avatar      *string        `gorm:"column:avatar"`
    Status      int32          `gorm:"column:status;default:1"`
    CreatedAt   time.Time      `gorm:"column:created_at;autoCreateTime"`
    UpdatedAt   time.Time      `gorm:"column:updated_at;autoUpdateTime"`
    DeletedAt   gorm.DeletedAt `gorm:"column:deleted_at;index"`
}
```

**æŠ€æœ¯ç‚¹**ï¼š
- GORM Gen è‡ªåŠ¨ç”Ÿæˆå®ä½“å’Œ CRUD æ–¹æ³•
- è½¯åˆ é™¤æ”¯æŒï¼ˆDeletedAtï¼‰
- å”¯ä¸€ç´¢å¼•ï¼ˆemail, usernameï¼‰

---

### Step 3: RPC Handler å®ç°

**æ–‡ä»¶**ï¼š`server/cmd/user/handler.go`

```go
func (s *UserServiceImpl) Register(ctx context.Context, req *user.RegisterRequest) (resp *user.RegisterResponse, err error) {
    resp = new(user.RegisterResponse)
    
    // 1. å‚æ•°æ ¡éªŒ
    if err := validateRegisterParams(req); err != nil {
        resp.BaseResp = errno.BuildBaseResp(err)
        return resp, nil
    }
    
    // 2. æ£€æŸ¥é‚®ç®±æ˜¯å¦å·²å­˜åœ¨
    u := s.Query.User
    existUser, err := u.WithContext(ctx).Where(u.Email.Eq(req.Email)).First()
    if err != nil && !errors.Is(err, gorm.ErrRecordNotFound) {
        klog.CtxErrorf(ctx, "query user by email failed: %v", err)
        resp.BaseResp = errno.BuildBaseResp(errno.UserSrvErr)
        return resp, nil
    }
    if existUser != nil {
        resp.BaseResp = errno.BuildBaseResp(errno.EmailAlreadyExist)
        return resp, nil
    }
    
    // 3. å¯†ç åŠ å¯†
    encryptedPassword := s.EncryptPassword(req.Password)
    
    // 4. ç”Ÿæˆç”¨æˆ·åï¼ˆä½¿ç”¨é‚®ç®±å‰ç¼€ï¼‰
    username := generateUsername(req.Email)
    
    // 5. åˆ›å»ºç”¨æˆ·
    newUser := &sqlentity.User{
        Username: username,
        Email:    req.Email,
        Password: encryptedPassword,
        Nickname: &req.Nickname,
        Status:   1, // æ­£å¸¸çŠ¶æ€
    }
    
    if err := u.WithContext(ctx).Create(newUser); err != nil {
        klog.CtxErrorf(ctx, "create user failed: %v", err)
        resp.BaseResp = errno.BuildBaseResp(errno.UserSrvErr)
        return resp, nil
    }
    
    // 6. è¿”å›ç»“æœ
    resp.BaseResp = errno.BuildBaseResp(nil)
    resp.UserId = int64(newUser.ID)
    
    klog.CtxInfof(ctx, "user registered successfully, user_id=%d", newUser.ID)
    return resp, nil
}

// å‚æ•°æ ¡éªŒ
func validateRegisterParams(req *user.RegisterRequest) error {
    // é‚®ç®±æ ¼å¼æ ¡éªŒ
    emailRegex := regexp.MustCompile(`^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$`)
    if !emailRegex.MatchString(req.Email) {
        return errno.ParamsErr.WithMessage("invalid email format")
    }
    
    // å¯†ç å¼ºåº¦æ ¡éªŒï¼ˆè‡³å°‘6ä½ï¼‰
    if len(req.Password) < 6 {
        return errno.InvalidPassword.WithMessage("password must be at least 6 characters")
    }
    
    return nil
}

// ç”Ÿæˆç”¨æˆ·å
func generateUsername(email string) string {
    parts := strings.Split(email, "@")
    if len(parts) > 0 {
        return parts[0]
    }
    return "user_" + strconv.FormatInt(time.Now().Unix(), 10)
}
```

**æŠ€æœ¯ç‚¹**ï¼š
1. **ä¸Šä¸‹æ–‡ä¼ é€’**ï¼šä½¿ç”¨ `ctx` ä¼ é€’é“¾è·¯è¿½è¸ªä¿¡æ¯
2. **GORM Gen æŸ¥è¯¢**ï¼š`u.WithContext(ctx).Where(...).First()`
3. **é”™è¯¯å¤„ç†**ï¼šç»Ÿä¸€ä½¿ç”¨ `errno.BuildBaseResp()`
4. **æ—¥å¿—è®°å½•**ï¼šä½¿ç”¨ `klog.CtxInfof/CtxErrorf` è®°å½•ä¸Šä¸‹æ–‡æ—¥å¿—
5. **å¯†ç åŠ å¯†**ï¼šè°ƒç”¨ `EncryptManager.EncryptPassword()`

---

### Step 4: API Gateway Handler å®ç°

**æ–‡ä»¶**ï¼š`server/cmd/api/biz/handler/user/user_service.go`

```go
func Register(ctx context.Context, c *app.RequestContext) {
    var req user.RegisterRequest
    // 1. å‚æ•°ç»‘å®šå’Œæ ¡éªŒ
    if err := c.BindAndValidate(&req); err != nil {
        c.JSON(consts.StatusBadRequest, errno.Response{
            Code:    int64(base.ErrCode_ParamsErr),
            Message: err.Error(),
            Data:    nil,
        })
        return
    }
    
    // 2. è°ƒç”¨ User RPC æœåŠ¡
    rpcReq := &rpcuser.RegisterRequest{
        Email:    req.Email,
        Password: req.Password,
        Nickname: req.Nickname,
    }
    
    rpcResp, err := rpc.UserClient.Register(ctx, rpcReq)
    if err != nil {
        klog.CtxErrorf(ctx, "rpc call failed: %v", err)
        c.JSON(consts.StatusInternalServerError, errno.Response{
            Code:    int64(base.ErrCode_RPCUserSrvErr),
            Message: "rpc call failed",
            Data:    nil,
        })
        return
    }
    
    // 3. æ£€æŸ¥ä¸šåŠ¡é”™è¯¯
    if rpcResp.BaseResp.StatusCode != int64(base.ErrCode_Success) {
        c.JSON(consts.StatusOK, errno.Response{
            Code:    rpcResp.BaseResp.StatusCode,
            Message: rpcResp.BaseResp.StatusMsg,
            Data:    nil,
        })
        return
    }
    
    // 4. è¿”å›æˆåŠŸå“åº”
    c.JSON(consts.StatusOK, errno.Response{
        Code:    0,
        Message: "success",
        Data: map[string]interface{}{
            "user_id": rpcResp.UserId,
        },
    })
}
```

**æŠ€æœ¯ç‚¹**ï¼š
1. **å‚æ•°ç»‘å®š**ï¼š`c.BindAndValidate()` è‡ªåŠ¨ç»‘å®šå’Œæ ¡éªŒ
2. **RPC è°ƒç”¨**ï¼šé€šè¿‡ `rpc.UserClient` è°ƒç”¨æœåŠ¡
3. **é”™è¯¯åˆ†å±‚**ï¼šåŒºåˆ† RPC é”™è¯¯å’Œä¸šåŠ¡é”™è¯¯
4. **ç»Ÿä¸€å“åº”**ï¼šä½¿ç”¨ `errno.Response` ç»“æ„

---

### Step 5: RPC å®¢æˆ·ç«¯åˆå§‹åŒ–

**æ–‡ä»¶**ï¼š`server/cmd/api/initialize/rpc/user_service.go`

```go
package rpc

import (
    "zpi/server/cmd/api/config"
    "zpi/server/shared/consts"
    "zpi/server/shared/kitex_gen/user/userservice"
    
    "github.com/cloudwego/kitex/client"
    "github.com/cloudwego/kitex/pkg/klog"
    "github.com/cloudwego/kitex/pkg/loadbalance"
    "github.com/cloudwego/kitex/pkg/rpcinfo"
    consul "github.com/kitex-contrib/registry-consul"
    "github.com/kitex-contrib/obs-opentelemetry/tracing"
)

var UserClient userservice.Client

func initUserRpc() {
    // Consul æœåŠ¡å‘ç°
    r, err := consul.NewConsulResolver(
        config.GlobalServerConfig.ConsulInfo.Host + ":" + 
        strconv.Itoa(config.GlobalServerConfig.ConsulInfo.Port),
    )
    if err != nil {
        klog.Fatalf("new consul resolver failed: %v", err)
    }
    
    // åˆ›å»º RPC å®¢æˆ·ç«¯
    c, err := userservice.NewClient(
        consts.UserServiceName,
        client.WithResolver(r),                    // æœåŠ¡å‘ç°
        client.WithLoadBalancer(loadbalance.NewWeightedBalancer()), // è´Ÿè½½å‡è¡¡
        client.WithMuxConnection(1),                               // å¤šè·¯å¤ç”¨
        client.WithSuite(tracing.NewClientSuite()),                // é“¾è·¯è¿½è¸ª
        client.WithClientBasicInfo(&rpcinfo.EndpointBasicInfo{
            ServiceName: consts.ApiServiceName,
        }),
    )
    if err != nil {
        klog.Fatalf("create user rpc client failed: %v", err)
    }
    
    UserClient = c
    klog.Info("user rpc client initialized")
}
```

**æŠ€æœ¯ç‚¹**ï¼š
1. **æœåŠ¡å‘ç°**ï¼šConsul Resolver
2. **è´Ÿè½½å‡è¡¡**ï¼šåŠ æƒè½®è¯¢
3. **è¿æ¥å¤ç”¨**ï¼šMuxConnection
4. **é“¾è·¯è¿½è¸ª**ï¼šOpenTelemetry
5. **è¶…æ—¶æ§åˆ¶**ï¼šå¯é…ç½®è¶…æ—¶æ—¶é—´

---

## ğŸ§ª æµ‹è¯•ç”¨ä¾‹

### å•å…ƒæµ‹è¯•

**æ–‡ä»¶**ï¼š`server/cmd/user/handler_test.go`

```go
func TestRegister(t *testing.T) {
    // æµ‹è¯•ç”¨ä¾‹
    tests := []struct {
        name    string
        req     *user.RegisterRequest
        wantErr boolerrCode base.ErrCode
    }{
        {
            name: "æ­£å¸¸æ³¨å†Œ",
            req: &user.RegisterRequest{
                Email:    "test@example.com",
                Password: "123456",
                Nickname: "æµ‹è¯•ç”¨æˆ·",
            },
            wantErr: false,},
        {
            name: "é‚®ç®±æ ¼å¼é”™è¯¯",
            req: &user.RegisterRequest{
                Email:    "invalid-email",
                Password: "123456",},
            wantErr: true,
            errCode: base.ErrCode_ParamsErr,
        },
        {
            name: "å¯†ç å¤ªçŸ­",
            req: &user.RegisterRequest{
                Email:    "test@example.com",
                Password: "123",
            },
            wantErr: true,
            errCode: base.ErrCode_InvalidPassword,
        },
        {
            name: "é‚®ç®±å·²å­˜åœ¨",
            req: &user.RegisterRequest{
                Email:    "existing@example.com",
                Password: "123456",
            },
            wantErr: true,
            errCode: base.ErrCode_EmailAlreadyExist,
        },
    }
    
    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            // æ‰§è¡Œæµ‹è¯•
            resp, err := handler.Register(context.Background(), tt.req)
            
            if tt.wantErr {
                assert.NotEqual(t, base.ErrCode_Success, resp.BaseResp.StatusCode)
                assert.Equal(t, tt.errCode, base.ErrCode(resp.BaseResp.StatusCode))
            } else {
                assert.Equal(t, base.ErrCode_Success, base.ErrCode(resp.BaseResp.StatusCode))
                assert.Greater(t, resp.UserId, int64(0))
            }
        })
    }
}
```

### é›†æˆæµ‹è¯•

```bash
# ä½¿ç”¨ curl æµ‹è¯•
curl -X POST http://localhost:8080/api/v1/user/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "password": "123456",
    "nickname": "æµ‹è¯•ç”¨æˆ·"
  }'

# é¢„æœŸå“åº”
{
  "code": 0,
  "message": "success",
  "data": {
    "user_id": 1
  }
}
```

---

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | è¯´æ˜ |
|------|--------|------|
| **å“åº”æ—¶é—´** | < 100ms | P99 |
| **QPS** | > 1000 | å•æœº |
| **æˆåŠŸç‡** | > 99.9% | æ’é™¤å‚æ•°é”™è¯¯ |
| **æ•°æ®åº“è¿æ¥** | < 50 | è¿æ¥æ±  |

---

## ğŸ” ç›‘æ§å’Œæ—¥å¿—

### æ—¥å¿—ç¤ºä¾‹

```
[INFO] 2024-12-21 19:30:15 [user_service] user registered successfully, user_id=1001, email=test@example.com
[ERROR] 2024-12-21 19:30:20 [user_service] create user failed: duplicate key error, email=test@example.com
```

### é“¾è·¯è¿½è¸ª

```
API Gateway (Register)
  â””â”€> User RPC Service (Register)
      â””â”€> MySQL (INSERT users)
```

### ç›‘æ§æŒ‡æ ‡

- æ³¨å†ŒæˆåŠŸç‡
- æ³¨å†Œå¤±è´¥åŸå› åˆ†å¸ƒ
- æ•°æ®åº“æŸ¥è¯¢è€—æ—¶
- RPC è°ƒç”¨è€—æ—¶

---

## ğŸš€ éƒ¨ç½²æ¸…å•

### ç¯å¢ƒå˜é‡

```yaml
# User Service
MYSQL_HOST: localhost
MYSQL_PORT: 3306
MYSQL_USER: root
MYSQL_PASSWORD: password
MYSQL_DB: zpi
MYSQL_SALT: your-salt-key

CONSUL_HOST: localhost
CONSUL_PORT: 8500

OTEL_ENDPOINT: localhost:4317
```

### ä¾èµ–æœåŠ¡

- âœ… MySQL 8.0
- âœ… Consul
- âœ… OpenTelemetry Collector

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Kitex æ–‡æ¡£](https://www.cloudwego.io/zh/docs/kitex/)
- [Hertz æ–‡æ¡£](https://www.cloudwego.io/zh/docs/hertz/)
- [GORM æ–‡æ¡£](https://gorm.io/zh_CN/)
- [Consul æ–‡æ¡£](https://www.consul.io/docs)

---

*æœ€åæ›´æ–°ï¼š2024-12-21*