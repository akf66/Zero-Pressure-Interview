# 代码生成执行目录

> 本项目使用代码生成器自动生成 RPC、HTTP 和 DAO 代码

---

## 1. 生成共享 Model 库（Kitex Gen）

```shell
cd server/shared
kitex -module zpi ../../idl/rpc/user.thrift

# 说明：
# - 生成 RPC 相关的共享代码
# - 输出目录：server/shared/kitex_gen/
# - 其中 zpi 替换为自己的 go mod 包名称
```

---

## 2. 创建 Kitex RPC 服务

```shell
cd server/cmd/user
kitex -service user \
      -module zpi \
      -use zpi/server/shared/kitex_gen \
      ../../idl/rpc/user.thrift

# 说明：
# - 创建 RPC 服务框架
# - 生成 handler.go、main.go 等文件
# - 使用共享的 kitex_gen 代码
```

---

## 3. 创建 Hertz HTTP 服务

```shell
cd server/cmd/api
hz new -idl ../../idl/http/user.thrift -module zpi/server/cmd/api

# 说明：
# - 创建 HTTP 服务框架
# - 生成路由、handler 等文件
```

---

## 4. DAO 层开发流程 ⭐

### 4.1 设计流程

```
1. 设计数据表结构
   ↓
2. 编写 SQL 文件（server/shared/dal/sql/*.sql）
   ↓
3. 运行代码生成器
   ↓
4. 自动生成实体和 CRUD 方法
```

### 4.2 修改/新增数据表

**步骤 1：编辑 SQL 文件**
```shell
# 修改现有表
vim server/shared/dal/sql/users.sql

# 或新增表
vim server/shared/dal/sql/resumes.sql
```

**步骤 2：运行代码生成器**
```shell
cd server/shared/dal/cmd/gen
go run main.go
```

**自动生成的文件**：
- `server/shared/dal/sqlentity/*.gen.go` - 数据库实体（对应表结构）
- `server/shared/dal/sqlfunc/*.gen.go` - CRUD 方法（类型安全的查询）
- `server/shared/dal/sqlfunc/gen.go` - 统一的 Query 对象

### 4.3 示例：修改 users 表

```sql
-- server/shared/dal/sql/users.sql
CREATE TABLE IF NOT EXISTS `users` (
    `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
    `username` VARCHAR(50) NOT NULL,
    `email` VARCHAR(100) NOT NULL,
    `phone` VARCHAR(20) DEFAULT NULL,
    -- 其他字段...
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_email` (`email`),
    UNIQUE KEY `uk_phone` (`phone`)  -- 修改：改为唯一索引
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

运行生成器后，会自动更新：
- `sqlentity/users.gen.go` - User 结构体
- `sqlfunc/users.gen.go` - User 的 CRUD 方法

### 4.4 使用生成的 DAO 代码

```go
import (
    "zpi/server/shared/dal/sqlfunc"
    "zpi/server/shared/dal/sqlentity"
)

// 初始化
db := initDB() // gorm.DB
query := sqlfunc.Use(db)

// 查询用户
u := query.User
user, err := u.WithContext(ctx).Where(u.Email.Eq("test@example.com")).First()

// 创建用户
newUser := &sqlentity.User{
    Username: "test",
    Email:    "test@example.com",
}
err := u.WithContext(ctx).Create(newUser)
```

---

## 5. 完整开发流程总结

### 新增功能的标准流程

```
1. 设计 IDL（Thrift）
   ├── server/idl/base/*.thrift（基础类型）
   ├── server/idl/rpc/*.thrift（RPC 接口）
   └── server/idl/http/*.thrift（HTTP 接口）

2. 设计数据表
   └── server/shared/dal/sql/*.sql

3. 生成代码
   ├── 生成 RPC 代码：cd server/shared && kitex -module zpi ../../idl/rpc/*.thrift
   ├── 生成 HTTP 代码：cd server/cmd/api && hz update -idl ../../idl/http/*.thrift
   └── 生成 DAO 代码：cd server/shared/dal/cmd/gen && go run main.go

4. 实现业务逻辑
   ├── RPC Handler（server/cmd/*/handler.go）
   └── HTTP Handler（server/cmd/api/biz/handler/*/*.go）

5. 测试和部署
```

---

## 6. 注意事项

### IDL 修改
- 修改 IDL 后，必须重新生成代码
- RPC 和 HTTP 的 IDL 要保持一致

### 数据库修改
- **先修改 SQL 文件，再运行生成器**
- 不要手动修改 `*.gen.go` 文件（会被覆盖）
- 生产环境使用 ALTER 语句迁移

### 代码生成器
- GORM Gen：`server/shared/dal/cmd/gen/main.go`
- Kitex：`kitex` 命令
- Hertz：`hz` 命令

---

*最后更新：2024-12-21*